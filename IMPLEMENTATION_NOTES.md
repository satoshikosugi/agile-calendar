# 実装ノート - カレンダー大改善

## 実装完了日
2025年12月6日

## 変更されたファイル一覧

### コア機能
1. **src/services/calendarLayoutService.ts** - カレンダーレイアウトの完全再設計
2. **src/services/tasksService.ts** - タスク表示とURL機能の強化
3. **src/components/TaskForm.tsx** - URL入力フィールドの追加

### ドキュメント
4. **README.md** - 機能説明の更新
5. **CALENDAR_REDESIGN_SUMMARY.md** - 詳細な実装サマリー（新規作成）

## 主要な変更内容

### 1. カレンダーレイアウトの数値

#### フレームサイズ
```typescript
const CALENDAR_FRAME_WIDTH = 2800;   // 7日 × 400px
const CALENDAR_FRAME_HEIGHT = 2400;  // 6週 × 400px
const CALENDAR_FRAME_SPACING = 300;  // フレーム間隔
```

#### レイアウト構造
```
┌─────────────────────────────────────────────┐
│          2025年 12月 (ヘッダー: 80px)          │
├─────────────────────────────────────────────┤
│  日  月  火  水  木  金  土  (曜日: 40px)      │
├───┬───┬───┬───┬───┬───┬───┤
│ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │ 第1週 (400px)
├───┼───┼───┼───┼───┼───┼───┤
│ 8 │ 9 │10 │11 │12 │13 │14 │ 第2週
├───┼───┼───┼───┼───┼───┼───┤
│15 │16 │17 │18 │19 │20 │21 │ 第3週
├───┼───┼───┼───┼───┼───┼───┤
│22 │23 │24 │25 │26 │27 │28 │ 第4週
├───┼───┼───┼───┼───┼───┼───┤
│29 │30 │31 │   │   │   │   │ 第5週
├───┼───┼───┼───┼───┼───┼───┤
│   │   │   │   │   │   │   │ 第6週 (予備)
└───┴───┴───┴───┴───┴───┴───┘

各セル: 400px × 400px
```

#### セル内レイアウト
```
┌─────────────────────────┐
│ 1日                      │ ← 日付番号（左上）
│                          │
│  左半分   │   右半分      │
│ チーム    │  個人スケ     │
│ タスク    │  ジュール     │
│          │              │
│  ↑       │      ↑       │
│  時刻     │     時刻      │
│  に基     │     に基      │
│  づく     │     づく      │
│  配置     │     配置      │
│  ↓       │      ↓       │
└─────────────────────────┘
```

### 2. タスク配置アルゴリズム

#### 位置計算の流れ
1. 日付から週番号と曜日を計算
2. フレーム内のセル位置を特定
3. チーム/個人による左右オフセット
4. 時刻による垂直オフセット

#### 時刻マッピング
```typescript
// 9:00-18:00 を セルの高さ60%にマッピング
const WORK_DAY_START_MINUTES = 9 * 60;   // 540分
const WORK_DAY_END_MINUTES = 18 * 60;    // 1080分

例:
  9:00 → セル上部
 13:30 → セル中央
 18:00 → セル下部
```

### 3. タスクの視覚表現

#### ステータス別の色
```typescript
'Draft'     → #fef9e7 (薄い黄色)
'Planned'   → #e8f5e9 (薄い緑)
'Scheduled' → #e3f2fd (薄い青)
'Done'      → #f5f5f5 (グレー)
'Canceled'  → #ffebee (薄い赤)
```

#### 付箋のコンテンツ形式
- 時刻なし: "タスク名"
- 時刻あり: "14:00 タスク名"

#### 外部リンクインジケーター
```
付箋の右上に配置:
┌─────────┐   ⭕🔗
│         │  ↑ リンクアイコン
│  タスク  │  (24px × 24px)
│         │  青色の円形
└─────────┘
```

位置:
- X: 付箋X + 90px
- Y: 付箋Y - 60px

### 4. パフォーマンス考慮事項

#### 効率化した処理
- `removeExistingLinkShapes()`: 重複コードを統合
- 時刻のバリデーション: 正規表現で検証
- 定数化: マジックナンバーを排除

#### 今後の最適化候補
1. リンクインジケーター検索の最適化（現在はO(n)）
2. カレンダー再生成時の差分更新
3. 大量タスク表示時のバッチ処理

### 5. 使用方法

#### タスク作成フロー
1. Tasksタブで「新規タスク」をクリック
2. タイトル、概要、日付を入力
3. （オプション）外部リンク（URL）を入力
4. 開始時刻と所要時間を設定
5. ステータスを選択
6. 保存

#### カレンダー生成フロー
1. Settingsタブで基準月を設定
2. Calendarタブで「カレンダー生成/更新」をクリック
3. 3ヶ月分のカレンダーがボードに生成される
4. 前月/次月ボタンで月を移動

#### タスクの配置
- タスクは自動的に指定した日付のセルに配置される
- 時刻が設定されていれば適切な高さに配置される
- URLがあればリンクアイコンが表示される

## テスト結果

### ビルド
✅ TypeScriptコンパイル成功
✅ Viteビルド成功
⚠️ CSS警告あり（既存の問題、機能に影響なし）

### セキュリティ
✅ CodeQL検査: 0件の脆弱性

### コード品質
✅ 定数抽出完了
✅ 重複コード削除
✅ 入力バリデーション追加
✅ 型安全性確保

## 既知の制限事項

1. **外部リンクのクリック**: 現在はリンクアイコンは視覚表示のみ。クリックしても開かない。
   - 理由: Miro Web SDKの制限
   - 回避策: タスク編集画面でURLを確認

2. **タスクの手動移動**: タスクを手動で移動すると、位置情報が更新されない。
   - 理由: Miroのイベントリスナーは未実装
   - 回避策: タスク編集で日付を変更して再配置

3. **セル容量**: 1つのセルに大量のタスクを配置すると重なる可能性がある。
   - 推奨: 1日あたり4-6タスク程度まで

4. **時刻範囲**: 9:00-18:00以外の時刻は配置が最適化されない。
   - 設定変更可能: `WORK_DAY_START_MINUTES` / `WORK_DAY_END_MINUTES`

## 今後の改善案

### 短期（優先度：高）
- [ ] リンクアイコンをクリック可能にする
- [ ] タスクのドラッグ＆ドロップ対応
- [ ] セル内タスクの自動整列

### 中期（優先度：中）
- [ ] 個人スケジュール機能の完全実装
- [ ] タスクのフィルタリング機能
- [ ] カレンダービューのズーム機能

### 長期（優先度：低）
- [ ] カスタムテーマ
- [ ] 週の開始曜日の変更
- [ ] 複数プロジェクトの管理

## 参考情報

### Miro Web SDK
- バージョン: v2.17.2
- ドキュメント: https://developers.miro.com/docs/web-sdk-reference

### 関連ファイル
- 仕様書: `develop.md`
- 実装サマリー: `CALENDAR_REDESIGN_SUMMARY.md`
- README: `README.md`

## 変更履歴

### 2025-12-07
- 個人スケジュール（付箋）のレイアウトを改善
  - 幅を180pxに縮小し、2列表示（偶数/奇数インデックス）に対応
  - タスク再編成ロジックに個人スケジュールを含めるよう修正
- カレンダーレイアウトの完全再設計
- URL機能の実装
- ステータス別色分けの実装
- コードリファクタリング
- ドキュメント整備

---

**実装者ノート**: すべての変更は最小限の修正で既存機能を壊さないよう設計されています。後方互換性も維持されています。
