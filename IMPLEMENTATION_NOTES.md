# 実装ノート - カレンダー大改善

## 実装完了日
2025年12月6日

## 変更されたファイル一覧

### コア機能
1. **src/services/calendarLayoutService.ts** - カレンダーレイアウトの完全再設計
2. **src/services/tasksService.ts** - タスク表示とURL機能の強化
3. **src/components/TaskForm.tsx** - URL入力フィールドの追加

### ドキュメント
4. **README.md** - 機能説明の更新
5. **CALENDAR_REDESIGN_SUMMARY.md** - 詳細な実装サマリー（新規作成）

## 主要な変更内容

### 1. カレンダーレイアウトの数値

#### フレームサイズ
```typescript
const CALENDAR_FRAME_WIDTH = 5600;   // 8列 × 700px (7日 + Weekly)
const CALENDAR_FRAME_HEIGHT = 4800;  // 6週 × 800px
const CALENDAR_FRAME_SPACING = 600;  // フレーム間隔
```

#### レイアウト構造
```
┌─────────────────────────────────────────────┐
│          2025年 12月 (ヘッダー: 160px)         │
├─────────────────────────────────────────────┤
│  日  月  火  水  木  金  土  Weekly (曜日: 80px) │
├───┬───┬───┬───┬───┬───┬───┬───┤
│ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │ W │ 第1週 (760px)
├───┼───┼───┼───┼───┼───┼───┼───┤
...
└───┴───┴───┴───┴───┴───┴───┴───┘
```

### 2. フック（ドロップ検知）の仕組み改善
- **以前**: `frame.getChildren()` を使用したヒットテスト（API遅延により不安定）
- **現在**: 座標計算（Math-based）による判定
  - フレームの座標とサイズから、ドロップ位置がどの日付セルに該当するかを計算
  - APIコールを減らし、即時性と信頼性を向上
  - `getDateFromPosition` 関数で実装
  - デバウンス時間を 2000ms -> 500ms に短縮し、レスポンスを向上
  - 同一日付内での移動でもスナップ（整列）するように修正

### 3. パフォーマンス最適化
- カレンダー生成時の並列処理（`Promise.all`）導入
- ただし `frame.add()` は競合回避のため順次実行
- `reorganizeTasksOnDate` での不要なAPIコール削減

#### セル内レイアウト
```
┌─────────────────────────┐
│ 1日                      │ ← 日付番号（左上）
│                          │
│  左半分   │   右半分      │
│ チーム    │  個人スケ     │
│ タスク    │  ジュール     │
│          │              │
│  ↑       │      ↑       │
│  時刻     │     時刻      │
│  に基     │     に基      │
│  づく     │     づく      │
│  配置     │     配置      │
│  ↓       │      ↓       │
└─────────────────────────┘
```

### 2. タスク配置アルゴリズム

#### 位置計算の流れ
1. 日付から週番号と曜日を計算
2. フレーム内のセル位置を特定
3. チーム/個人による左右オフセット
4. 時刻による垂直オフセット

#### 時刻マッピング
```typescript
// 9:00-18:00 を セルの高さ60%にマッピング
const WORK_DAY_START_MINUTES = 9 * 60;   // 540分
const WORK_DAY_END_MINUTES = 18 * 60;    // 1080分

例:
  9:00 → セル上部
 13:30 → セル中央
 18:00 → セル下部
```

### 3. タスクの視覚表現

#### ステータス別の色
```typescript
'Draft'     → #fef9e7 (薄い黄色)
'Planned'   → #e8f5e9 (薄い緑)
'Scheduled' → #e3f2fd (薄い青)
'Done'      → #f5f5f5 (グレー)
'Canceled'  → #ffebee (薄い赤)
```

#### 付箋のコンテンツ形式
- 時刻なし: "タスク名"
- 時刻あり: "14:00 タスク名"

#### 外部リンクインジケーター
```
付箋の右上に配置:
┌─────────┐   ⭕🔗
│         │  ↑ リンクアイコン
│  タスク  │  (24px × 24px)
│         │  青色の円形
└─────────┘
```

位置:
- X: 付箋X + 90px
- Y: 付箋Y - 60px

### 4. パフォーマンス考慮事項

#### 効率化した処理
- `removeExistingLinkShapes()`: 重複コードを統合
- 時刻のバリデーション: 正規表現で検証
- 定数化: マジックナンバーを排除

#### 今後の最適化候補
1. リンクインジケーター検索の最適化（現在はO(n)）
2. カレンダー再生成時の差分更新
3. 大量タスク表示時のバッチ処理

### 5. 使用方法

#### タスク作成フロー
1. Tasksタブで「新規タスク」をクリック
2. タイトル、概要、日付を入力
3. （オプション）外部リンク（URL）を入力
4. 開始時刻と所要時間を設定
5. ステータスを選択
6. 保存

#### カレンダー生成フロー
1. Settingsタブで基準月を設定
2. Calendarタブで「カレンダー生成/更新」をクリック
3. 3ヶ月分のカレンダーがボードに生成される
4. 前月/次月ボタンで月を移動

#### タスクの配置
- タスクは自動的に指定した日付のセルに配置される
- 時刻が設定されていれば適切な高さに配置される
- URLがあればリンクアイコンが表示される

## テスト結果

### ビルド
✅ TypeScriptコンパイル成功
✅ Viteビルド成功
⚠️ CSS警告あり（既存の問題、機能に影響なし）

### セキュリティ
✅ CodeQL検査: 0件の脆弱性

### コード品質
✅ 定数抽出完了
✅ 重複コード削除
✅ 入力バリデーション追加
✅ 型安全性確保

## 既知の制限事項

1. **外部リンクのクリック**: 現在はリンクアイコンは視覚表示のみ。クリックしても開かない。
   - 理由: Miro Web SDKの制限
   - 回避策: タスク編集画面でURLを確認

2. **タスクの手動移動**: タスクを手動で移動すると、位置情報が更新されない。
   - 理由: Miroのイベントリスナーは未実装
   - 回避策: タスク編集で日付を変更して再配置

3. **セル容量**: 1つのセルに大量のタスクを配置すると重なる可能性がある。
   - 推奨: 1日あたり4-6タスク程度まで

4. **時刻範囲**: 9:00-18:00以外の時刻は配置が最適化されない。
   - 設定変更可能: `WORK_DAY_START_MINUTES` / `WORK_DAY_END_MINUTES`

## 今後の改善案

### 短期（優先度：高）
- [ ] リンクアイコンをクリック可能にする
- [ ] タスクのドラッグ＆ドロップ対応
- [ ] セル内タスクの自動整列

### 中期（優先度：中）
- [ ] 個人スケジュール機能の完全実装
- [ ] タスクのフィルタリング機能
- [ ] カレンダービューのズーム機能

### 長期（優先度：低）
- [ ] カスタムテーマ
- [ ] 週の開始曜日の変更
- [ ] 複数プロジェクトの管理

## 参考情報

### Miro Web SDK
- バージョン: v2.17.2
- ドキュメント: https://developers.miro.com/docs/web-sdk-reference

### 関連ファイル
- 仕様書: `develop.md`
- 実装サマリー: `CALENDAR_REDESIGN_SUMMARY.md`
- README: `README.md`

## 変更履歴

### 2025-12-07
- 個人スケジュール（付箋）のレイアウトを改善
  - 幅を180pxに縮小し、2列表示（偶数/奇数インデックス）に対応
  - タスク再編成ロジックに個人スケジュールを含めるよう修正
- カレンダーレイアウトの完全再設計
- URL機能の実装
- ステータス別色分けの実装
- コードリファクタリング
- ドキュメント整備

### 2025-12-08
- カレンダー生成のパフォーマンス改善と安定化
  - **グローバル検索の廃止**: レート制限回避のため、ボード全体検索ロジックを削除
  - **生成ロジックの最適化**:
    - 週単位の並列処理を廃止し、日単位の逐次処理に変更（フレーム追加の確実性を優先）
    - 日単位の中で、セル・日付・区切り線の生成のみ並列化し、速度低下を最小限に抑制
    - `frame.add` を各日の生成直後に実行することで、親子関係の不整合を防止
- タスク移動検知の抜本的改善
  - **座標計算ベースの日付判定（Strategy C: Math-based）を最優先に変更**
    - 従来の子要素検索（Hit Testing）は、Miroの内部インデックス遅延により失敗するリスクが高いため、フォールバックに格下げ
    - フレームの位置とサイズから数学的に日付を算出することで、API呼び出しを最小限にし、高速かつ確実に日付を特定
  - ポーリングループの安定性判定を緩和（2px未満 → 5px未満）
  - エラー発生時の状態クリア処理を追加
- UI改善
  - タスク選択時の「編集」ボタンを、サイドパネル切り替えではなくポップアップ（モーダル）表示に変更
  - プラグインアイコンクリック時の挙動もポップアップ表示に統一

---

**実装者ノート**: すべての変更は最小限の修正で既存機能を壊さないよう設計されています。後方互換性も維持されています。
    - 週単位の並列処理を廃止し、日単位の逐次処理に変更（フレーム追加の確実性を優先）
    - 日単位の中で、セル・日付・区切り線の生成のみ並列化し、速度低下を最小限に抑制
    - `frame.add` を各日の生成直後に実行することで、親子関係の不整合を防止

---

**実装者ノート**: すべての変更は最小限の修正で既存機能を壊さないよう設計されています。後方互換性も維持されています。
- タスク移動検知の安定化
  - カレンダー生成時の `frame.add` 処理を並列から逐次実行に変更（競合状態の回避）
  - タスク移動時の日付判定ロジックに「グローバル検索」フォールバックを追加
    - フレーム階層構造が正しく反映されていない場合でも、座標ベースでセルを特定できるように修正

---

**実装者ノート**: すべての変更は最小限の修正で既存機能を壊さないよう設計されています。後方互換性も維持されています。
- タスク移動検知の安定化
  - カレンダー生成時の `frame.add` 処理を並列から逐次実行に変更（競合状態の回避）
  - 生成速度を維持しつつ、フレームへの要素追加を確実に行うよう修正

---

**実装者ノート**: すべての変更は最小限の修正で既存機能を壊さないよう設計されています。後方互換性も維持されています。

---

**実装者ノート**: すべての変更は最小限の修正で既存機能を壊さないよう設計されています。後方互換性も維持されています。
