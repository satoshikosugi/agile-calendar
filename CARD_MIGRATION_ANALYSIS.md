# 付箋→カード化の検討レポート

## 概要
現状のタスク表現方法（付箋）から、カードオブジェクトへの変更を検討するための調査レポート。

## 現状の問題点

### 1. ドラッグ操作の不安定性
現在のコードでは、タスク付箋のドラッグ移動時に以下の問題が発生している：
- ドラッグ中の座標取得が不安定（`board.get()`が古い座標を返す）
- 親フレームとの関係性の管理が複雑（`child of another board item`エラー）
- 5秒間のデバウンス処理が必要（ユーザー操作の遅延）

### 2. Rate Limit問題
付箋の移動処理で多数のAPI呼び出しが発生：
- `board.get()`での付箋取得（50 credits/call）
- `getMetadata()`でのメタデータ読み取り（50 credits/call）
- `setMetadata()`での更新（50 credits/call）
- `sync()`での同期（50 credits/call）
- 1タスク移動で200+ creditsを消費
- 複数タスクの同時移動でrate limit（100,000 credits/分）に到達しやすい

### 3. 現状の対策コスト
- retry機能の実装（`utils/retry.ts`）
- debounce処理による遅延（5秒待機）
- バッチ処理の実装
- 複雑な座標計算ロジック
- フレーム管理の複雑化

## Miro SDK Card オブジェクトの調査結果

### Card の基本機能

```typescript
// Miro SDK v2 の Card インターフェース（@mirohq/websdk-types より）
interface Card extends BaseItem {
  type: "card";
  width: number;
  readonly height: number;  // 自動計算
  rotation: number;
  title: string;
  description: string;
  style: CardStyle;
  dueDate?: string;
  startDate?: string;
  assignee?: CardAssignee;
  taskStatus: CardTaskStatus;  // 'to-do' | 'in-progress' | 'done' | 'none'
  tagIds: string[];
  fields?: CardField[];  // カスタムフィールド
}
```

### Card と Sticky Note の比較表

| 項目 | Sticky Note（現状） | Card |
|------|---------------------|------|
| **基本機能** | | |
| タイトル表示 | contentに含める | titleフィールド |
| 説明文 | contentに含める | descriptionフィールド |
| 色分け | fillColor | cardTheme + fillBackground |
| **タスク管理** | | |
| ステータス | メタデータで管理 | taskStatus（ネイティブ） |
| 期日 | メタデータで管理 | dueDate（ネイティブ） |
| 開始日 | メタデータで管理 | startDate（ネイティブ） |
| 担当者 | メタデータで管理 | assignee（ネイティブ） |
| カスタムフィールド | メタデータのみ | fields[]（ネイティブ） |
| **表示・UI** | | |
| 高さ | 固定または手動設定 | コンテンツに応じて自動 |
| 幅 | 固定（140px） | 設定可能 |
| アイコン表示 | HTML埋め込み（制限あり） | fields[]でアイコン対応 |
| **パフォーマンス** | | |
| 作成コスト | 50 credits | 50 credits |
| 更新コスト | 50 credits | 50 credits |
| メタデータ必要性 | 全情報を格納 | 基本情報は不要 |
| **ドラッグ操作** | | |
| イベント処理 | items:update | items:update |
| 座標管理 | 手動管理必要 | 手動管理必要 |

## メリット・デメリット分析

### カード化のメリット

#### 1. 構造化データの標準化 ⭐⭐⭐
- タスクに必要な情報（title, description, status, dates, assignee）が**ネイティブフィールド**として利用可能
- メタデータへの依存度が減少
- データモデルの明確化

#### 2. UI/UX の向上 ⭐⭐⭐
- タスクステータスの視覚的表現が標準化（to-do, in-progress, done）
- 期日・開始日が標準UIで表示可能
- 担当者表示が標準化
- カスタムフィールドでより柔軟な情報表示が可能

#### 3. メタデータアクセスの削減 ⭐⭐
- 基本情報（title, status, dates）はメタデータ読み取り不要
- API呼び出し回数の削減（理論上）
- ただし、アプリ固有のデータ（devPlan, rolesなど）は引き続きメタデータが必要

#### 4. 将来的な拡張性 ⭐⭐
- Miroのカード向け機能追加の恩恵を受けやすい
- サードパーティ連携の可能性（Jira, Trelloなど）
- テーブルビュー、タイムラインビューとの統合

### カード化のデメリット

#### 1. ドラッグ操作問題は解決しない ⚠️⚠️⚠️
**重要**: Cardに変更しても、根本的なドラッグ操作の問題は解決しない：
- `board.ui.on('experimental:items:update')`イベントは同じ
- 座標の取得と更新の仕組みは同じ
- フレームとの親子関係管理は同じ
- デバウンス処理は引き続き必要

#### 2. Rate Limit問題は改善が限定的 ⚠️⚠️
- ドラッグ時の`board.get()`は必要（50 credits）
- 位置更新のための`sync()`は必要（50 credits）
- メタデータ読み取りが一部減少するが、アプリ固有データ（devPlan, roles, externalParticipants等）は引き続きメタデータが必要
- **削減効果**: 1タスク移動あたり50-100 credits削減（元々200+なので約25-50%削減）

#### 3. 移行コストが大きい ⚠️⚠️⚠️
- **全コード書き換え**が必要:
  - `tasksService.ts`: 1223行のほぼ全面書き換え
  - `calendarLayoutService.ts`: 位置計算ロジックの調整
  - `miro.ts`: モックの実装変更
  - その他の関連ファイル
- **既存データの移行**が必要:
  - 既存の付箋をカードに変換
  - メタデータの再構築
  - ユーザーへの影響
- **テスト工数**:
  - 全機能の再テスト
  - バグ修正の工数

#### 4. カスタマイズの制約 ⚠️
- 付箋は`content`にHTMLを埋め込めるが、カードは制限がある
- 現在の実装（時刻表示、リンクアイコン、参加者情報）を再現するには`fields[]`の活用が必要
- fieldsの表示方法がMiroの標準UIに依存

#### 5. 高さの自動計算が課題 ⚠️
- Cardの`height`は読み取り専用で自動計算される
- 時間ベースの垂直配置（現在の実装）との整合性が不明確
- 複数タスクの重なり防止ロジックの調整が必要

#### 6. レイアウト互換性 ⚠️
- 現在の月間カレンダーレイアウト（400px × 400pxセル）との相性
- 左右分割レイアウト（チームタスク/個人スケジュール）への影響
- セル内の自動配置ロジックの再実装

## 技術的な懸念事項

### 1. メタデータ依存は継続
現在のTask型の多くのフィールドは、Cardのネイティブフィールドでカバーできない：
- `roles` (pmId, designerIds, devPlan)
- `externalParticipants`
- `constraints`
- `recurringTaskId`
- `summary`（詳細な説明）
- `time.duration`（開始時刻と期間の分離管理）

これらは引き続きメタデータで管理する必要がある。

### 2. ドラッグ操作の根本課題
調査結果によると：
- **ドラッグイベント自体は0 credits**（rate limitの対象外）
- **問題はドラッグ後の処理**:
  - アイテムの再取得（board.get）
  - メタデータの読み書き
  - 位置の更新（sync）
  - フレームへの追加/削除

これらは付箋でもカードでも同じ操作が必要。

### 3. デバウンス処理の必要性
現在の5秒デバウンスは、以下の理由で必要：
- Miroのドラッグ中の座標が不安定
- ユーザーが連続してドラッグする可能性
- バッチ処理によるrate limit回避

カードに変更してもこの必要性は変わらない。

## 代替案の検討

### 案1: 現状維持 + パフォーマンス最適化 ⭐⭐⭐（推奨）
**アプローチ**:
- 付箋のまま、rate limit対策を強化
- キャッシュ戦略の改善
- バッチ処理の最適化
- ユーザーフィードバックの改善

**メリット**:
- 移行コストゼロ
- 既存の動作を維持
- 段階的な改善が可能

**実装案**:
1. ローカルキャッシュの活用を拡大
2. フレーム内検索の最適化（既に実装済み）
3. 不要なメタデータ読み取りの削減
4. ドラッグ中のフィードバック改善（ローディング表示等）

### 案2: ハイブリッドアプローチ
**アプローチ**:
- 新規タスクはカードで作成
- 既存の付箋は段階的に移行
- 両方をサポートする期間を設ける

**メリット**:
- 移行リスクの分散
- ユーザー影響を最小化

**デメリット**:
- 実装の複雑化
- メンテナンスコスト増加
- 長期的には統一が必要

### 案3: 全面カード化（非推奨）
**理由**:
- 根本的な問題（ドラッグの不安定性）は解決しない
- Rate limitの改善は限定的（25-50%削減）
- 移行コストが大きすぎる（全コード書き換え）
- リスク対リターンが低い

## 推奨事項

### 短期的な対応（推奨度: 高）
1. **現状維持**を推奨
2. 以下の最適化に注力:
   - **キャッシュ戦略の改善**: `taskDateCache`の活用範囲拡大
   - **不要なAPI呼び出しの削減**: メタデータ読み取りの最小化
   - **ユーザーフィードバックの改善**: ドラッグ中の状態表示
   - **デバウンス時間の調整**: 5秒が妥当か検証

### 中期的な検討（推奨度: 中）
1. **Miro SDKの更新監視**:
   - Cardの新機能追加
   - ドラッグ操作APIの改善
   - Rate limitポリシーの変更

2. **段階的なリファクタリング**:
   - データモデルをCard互換に近づける
   - 将来的な移行を容易にする設計

### 長期的な判断基準
以下の条件が満たされた場合、カード化を再検討:
1. Miro SDKがドラッグ操作の改善APIを提供
2. Cardのカスタマイズ性が大幅に向上
3. Rate limitポリシーが改善（特にメタデータアクセス）
4. 移行ツールや自動変換機能が提供される

## まとめ

### 結論
**カード化は現時点では推奨しない**

### 理由
1. **根本的な問題（ドラッグの不安定性）は解決しない**
2. **Rate limit改善は限定的**（25-50%削減、絶対値として十分でない）
3. **移行コストが非常に大きい**（全面的なコード書き換え）
4. **リスク対リターンが低い**

### 代わりに推奨する対応
1. 現在の付箋ベースの実装を維持
2. パフォーマンス最適化に注力（キャッシュ、API呼び出し削減）
3. ユーザーエクスペリエンスの改善（フィードバック、状態表示）
4. Miro SDKの進化を監視し、将来的な移行を検討

### 定量的な評価

| 評価項目 | 付箋維持 | カード化 |
|---------|---------|---------|
| ドラッグ安定性改善 | 0% | 0% |
| Rate limit改善 | 0-10%（最適化で） | 25-50% |
| 実装コスト | 小（最適化のみ） | 大（全面書き換え） |
| リスク | 小 | 大 |
| ユーザー影響 | なし | あり（移行期間） |
| 将来性 | 中 | 高 |
| **総合推奨度** | ⭐⭐⭐⭐ | ⭐⭐ |

---

## 参考情報

### Miro SDK Rate Limits
- 最大 100,000 credits/分（約2,000アイテム作成相当）
- 最大 1,000,000 credits/時（約20,000アイテム作成相当）
- ドラッグイベントの監視: 0 credits
- アイテム作成: 50 credits
- アイテム更新: 50 credits

### 現在のコード規模
- `tasksService.ts`: 1223行
- `calendarLayoutService.ts`: 800行以上
- 関連ファイル: 10+

### 調査実施日
2025-12-12
